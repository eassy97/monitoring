<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Nastaven√≠ checku</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: 1fr;
            gap: 20px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 100%;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            background: #007bff;
            color: white;
            margin-right: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }
        th, td { padding: 8px; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        a { text-decoration: none; color: #007bff; }
        .status-large { font-size: 24px; font-weight: bold; margin-top: 10px; }
        .status-ok { color: #28a745; }
        .status-bad { color: #dc3545; }
        .chart-stats { display: flex; gap: 20px; margin-top: 10px; justify-content:center; }
        .chart-stats div { background:#f8d7da; color:#721c24; padding:8px 12px; border-radius:5px; }
        .email-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .email-tag { background:#e9ecef; padding:4px 8px; border-radius:3px; }
        .header { display:flex; justify-content:space-between; align-items:center; background:white; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .popup { position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); padding:10px 20px; border-radius:5px; box-shadow:0 2px 4px rgba(0,0,0,0.2); z-index:1000; }
        .popup-info { background:#d1ecf1; color:#0c5460; }
        .popup-danger { background:#f8d7da; color:#721c24; }
        .popup .close { margin-left:10px; cursor:pointer; font-weight:bold; }
    </style>
</head>
<body>
    <div class="header">
        <a href="{{ back_url }}" style="margin-right:15px;color:#007bff;text-decoration:none;">&larr; Zpƒõt</a>
        <h1>üõ†Ô∏è Monitorov√°n√≠ URL</h1>
        <div>
            {% if username %}
                <span>P≈ôihl√°≈°en jako: <strong>{{ username }}</strong></span>
                <a href="{{ url_for('advanced_settings') }}" style="margin-left:15px;color:#007bff;text-decoration:none;">‚öôÔ∏è Pokroƒçil√© nastaven√≠</a>
                <a href="{{ url_for('logout') }}" style="margin-left:15px;color:#007bff;text-decoration:none;">üö™ Odhl√°sit se</a>
            {% endif %}
        </div>
    </div>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            <div class="popup popup-{{ category }}"><span class="close" onclick="this.parentElement.style.display='none'">&times;</span>{{ message }}</div>
        {% endfor %}
    {% endwith %}
    <div class="grid-container">
        <div class="panel" style="grid-column: 1; grid-row: 1;">
            <h2>Nastaven√≠ checku</h2>
            <p><strong>URL:</strong> {{ check.url }}</p>
            <form method="POST" id="settingsForm">
                <div class="form-group">
                    <label>N√°zev:</label>
                    <input type="text" name="name" value="{{ check.name }}">
                </div>
                <div class="form-group" style="width:50%;margin:auto;">
                    <label>Interval:</label>
                    <select name="interval">
                        <option value="1" {% if check.interval==1 %}selected{% endif %}>1 s</option>
                        <option value="5" {% if check.interval==5 %}selected{% endif %}>5 s</option>
                        <option value="60" {% if check.interval==60 %}selected{% endif %}>1 min</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Poƒçet chyb pro notifikaci:</label>
                    <input type="number" name="threshold" value="{{ check.error_threshold }}" min="1">
                </div>
                <div class="form-group">
                    <label>E-mail pro notifikace:</label>
                    <input type="text" id="emailInput" name="email" value="{{ check.notify_email }}">
                    <div id="emailTags" class="email-tags"></div>
                </div>
                <div class="form-group" style="width:50%;margin:auto;">
                    <label>Pozastavit na:</label>
                    <select name="pause_minutes">
                        <option value="1">1 minuta</option>
                        <option value="5">5 minut</option>
                    </select>
                </div>
                <button type="submit" class="btn" name="action" value="save">Ulo≈æit</button>
                {% if check.status == 'paused' %}
                <button type="submit" class="btn" name="action" value="pause">Spustit</button>
                {% else %}
                <button type="submit" class="btn" name="action" value="pause">Pozastavit</button>
                {% endif %}
                <button type="button" class="btn" onclick="confirmDelete()">Smazat</button>
                <input type="hidden" name="action" id="deleteAction" value="">
            </form>
            {% if paused_until %}
            <p style="text-align:center;color:#dc3545;">Pozastaveno do {{ paused_until }}</p>
            {% endif %}
        </div>
        <div class="panel" style="grid-column:2; grid-row:1;">
            <h3>Obecn√©</h3>
            <p><strong>N√°zev:</strong> {{ check.name }}</p>
            <p><strong>URL:</strong> {{ check.url }}</p>
            <p><strong>Frekvence:</strong> {{ check.interval }}s</p>
            <p><strong>Posledn√≠ ƒças:</strong> {{ stats.last_time }}</p>
            <div class="status-large {{ 'status-ok' if stats.last_status == 'Available' else 'status-bad' }}">
                {% if stats.last_status == 'Available' %}‚úÖ{% else %}‚ùå{% endif %}
                {{ stats.last_status }}
            </div>
        </div>
        <div class="panel" style="grid-column:3; grid-row:1;">
            <h3>Odezvy</h3>
            <p>Denn√≠ pr≈Ømƒõr: {{ stats.response_day }}ms</p>
            <p>T√Ωdenn√≠ pr≈Ømƒõr: {{ stats.response_week }}ms</p>
            <p>Mƒõs√≠ƒçn√≠ pr≈Ømƒõr: {{ stats.response_month }}ms</p>
        </div>
        <div class="panel" style="grid-column:4; grid-row:1;">
            <h3>Uptime</h3>
            <p>Denn√≠: {{ stats.uptime_day }}%</p>
            <p>T√Ωdenn√≠: {{ stats.uptime_week }}%</p>
            <p>Mƒõs√≠ƒçn√≠: {{ stats.uptime_month }}%</p>
        </div>
        <div class="panel" style="grid-column:1 / span 4; grid-row:2;margin-top:20px;">
            <h3>Performance History</h3>
            <canvas id="perfChart" height="100"></canvas>
            <div class="chart-stats">
                <div>Run Count: {{ stats.run_count }}</div>
                <div>Errors: {{ stats.error_count }}</div>
                <div>Slowest: {{ stats.slowest }}ms</div>
                <div>Average: {{ stats.avg_time }}ms</div>
                <div>Fastest: {{ stats.fastest }}ms</div>
            </div>
        </div>
        <div class="panel" style="grid-column: 1 / span 4; grid-row: 3;">
            <h3>Historie bƒõh≈Ø</h3>
            <form method="get" style="margin-bottom:10px;display:flex;gap:10px;justify-content:flex-end;">
                <label>Na str√°nku:
                    <select name="per_page" onchange="this.form.submit()">
                        <option value="5" {% if per_page==5 %}selected{% endif %}>5</option>
                        <option value="10" {% if per_page==10 %}selected{% endif %}>10</option>
                        <option value="20" {% if per_page==20 %}selected{% endif %}>20</option>
                    </select>
                </label>
                <label>≈òazen√≠:
                    <select name="sort" onchange="this.form.submit()">
                        <option value="desc" {% if sort=='desc' %}selected{% endif %}>Nov√© prvn√≠</option>
                        <option value="asc" {% if sort=='asc' %}selected{% endif %}>Star√© prvn√≠</option>
                    </select>
                </label>
                <input type="hidden" name="page" value="{{ page }}">
            </form>
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>ƒåas</th>
                        <th>Stav</th>
                        <th>Odezva</th>
                        <th>Zpr√°va</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in history %}
                    <tr>
                        <td>{{ item.timestamp }}</td>
                        <td>{{ item.status }}</td>
                        <td>{{ item.response_time }}ms</td>
                        <td>{{ item.message }}</td>
                    </tr>
                    {% endfor %}
                    {% if not history %}
                    <tr><td colspan="4">≈Ω√°dn√© z√°znamy</td></tr>
                    {% endif %}
                </tbody>
            </table>
            <div style="text-align:center;margin-top:10px;">
                <a href="{{ url_for('check_settings', check_id=check_id, page=page-1 if page>1 else 1, per_page=per_page, sort=sort) }}">&laquo; P≈ôedchoz√≠</a>
                <span>Str√°nka {{ page }} / {{ pages }}</span>
                <a href="{{ url_for('check_settings', check_id=check_id, page=page+1 if page<pages else pages, per_page=per_page, sort=sort) }}">Dal≈°√≠ &raquo;</a>
                <button type="button" class="btn" onclick="refreshHistory()" style="margin-left:15px;">üîÑ Refresh</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const popupConfig = {{ popup | tojson }};
        const currentCheck = '{{ check_id }}';
        function showPopup(msg, type='info') {
            const cfg = popupConfig[type] || popupConfig.info;
            const div = document.createElement('div');
            div.className = 'popup';
            div.style.background = cfg.color;
            div.style.width = cfg.width + 'px';
            div.style.height = cfg.height + 'px';
            div.innerHTML = `<span class="close" onclick="this.parentElement.remove()">&times;</span>` + cfg.text.replace('{message}', msg);
            document.body.appendChild(div);
            setTimeout(()=>div.remove(), 3000);
        }
        function confirmDelete() {
            const cfg = popupConfig.delete;
            const div = document.createElement('div');
            div.className = 'popup';
            div.style.background = cfg.color;
            div.style.width = cfg.width + 'px';
            div.style.height = cfg.height + 'px';
            div.innerHTML = `<span class="close" onclick="this.parentElement.remove()">&times;</span>` +
                cfg.text.replace('{message}', 'Napi≈°te delete pro potvrzen√≠') +
                `<br><input type="text" id="delInput" style="width:90%;margin-top:10px;"><br>` +
                `<button class="btn" style="margin-top:5px;" onclick="doDelete()">OK</button>`;
            document.body.appendChild(div);
        }
        function doDelete() {
            const inp = document.getElementById('delInput');
            if (inp && inp.value.toLowerCase() === 'delete') {
                document.getElementById('deleteAction').value = 'delete';
                document.getElementById('settingsForm').submit();
            }
        }
        const labels = {{ chart_labels | safe }};
        const times = {{ chart_times | safe }};
        const ctx = document.getElementById('perfChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Response Time (ms)',
                    data: times,
                    borderColor: 'rgb(75, 192, 192)',
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        const emailInput = document.getElementById('emailInput');
        const tagContainer = document.getElementById('emailTags');
        function renderTags() {
            tagContainer.innerHTML = '';
            const emails = emailInput.value.split(';').map(e => e.trim()).filter(e => e);
            for (const em of emails) {
                const span = document.createElement('span');
                span.className = 'email-tag';
                span.textContent = em;
                tagContainer.appendChild(span);
            }
        }
        emailInput.addEventListener('input', renderTags);
        renderTags();

        async function refreshHistory() {
            const resp = await fetch(`/check/${currentCheck}/history_json?page={{ page }}&per_page={{ per_page }}&sort={{ sort }}`);
            const data = await resp.json();
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            for (const item of data.history) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.timestamp}</td><td>${item.status}</td><td>${item.response_time}ms</td><td>${item.message}</td>`;
                tbody.appendChild(tr);
            }
            if (data.history.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="4">≈Ω√°dn√© z√°znamy</td>';
                tbody.appendChild(tr);
            }
        }
    </script>
</body>
</html>
