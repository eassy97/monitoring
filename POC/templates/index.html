<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Monitorov√°n√≠ URL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            align-items: flex-start;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .history {
            max-height: 600px;
            overflow-y: auto;
        }
        .controls {
            margin-bottom: 0;
        }
        .active-checks {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-indicator { 
            padding: 8px 15px; 
            border-radius: 20px; 
            font-weight: bold; 
            margin-left: 10px;
        }
        .status-active { background: #28a745; color: white; }
        .status-inactive { background: #dc3545; color: white; }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .active-checks-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .active-checks-table th, 
        .active-checks-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .active-checks-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .active-checks-table tr:hover { 
            background: #f5f5f5; 
        }
        .ping-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .ping-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .ping-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .history-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        .empty-state {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }
        .flash-messages {
            margin-bottom: 20px;
        }
        .flash-message {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .flash-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .flash-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <a href="{{ url_for('index') }}" style="margin-right:15px;color:#007bff;text-decoration:none;">üè† Dom≈Ø</a>
        </div>
        <h1>üõ†Ô∏è Monitorov√°n√≠ URL</h1>
        <div>
            {% if username %}
                <span>P≈ôihl√°≈°en jako: <strong>{{ username }}</strong></span>
                <a href="{{ url_for('advanced_settings') }}" style="margin-left:15px;color:#007bff;text-decoration:none;">‚öôÔ∏è Pokroƒçil√© nastaven√≠</a>
                <a href="{{ url_for('logout') }}" style="margin-left:15px;color:#007bff;text-decoration:none;">üö™ Odhl√°sit se</a>
            {% endif %}
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="container">
        <div class="controls panel">
            <h2>üöÄ Nov√Ω monitoring</h2>
            <form id="monitorForm">
                <div class="form-group">
                    <label for="nameInput">N√°zev checku:</label>
                    <input type="text" id="nameInput" placeholder="Moje slu≈æba">
                    </div>
                    <div class="form-group">
                        <label for="urlInput">URL adresa:</label>
                        <input type="url" id="urlInput" placeholder="https://example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="intervalSelect">Interval kontroly:</label>
                        <select id="intervalSelect">
                            <option value="1">üïê 1 sekunda</option>
                            <option value="5">üïî 5 sekund</option>
                            <option value="60">üïõ 1 minuta</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="startMonitoring()">
                        ‚ñ∂Ô∏è Spustit monitoring
                    </button>
                </form>
            </div>

        <div class="active-checks panel">
            <h2>üìä Aktivn√≠ checky</h2>
                <table class="active-checks-table" id="activeChecksTable">
                    <thead>
                        <tr>
                            <th>N√°zev</th>
                            <th>URL</th>
                            <th>Interval</th>
                            <th>Posledn√≠ v√Ωsledek</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="activeChecksBody">
                        {% for check_id, data in active_checks.items() %}
                        <tr id="row-{{ check_id }}">
                            <td>{{ data.name }}</td>
                            <td>{{ data.url }}</td>
                            <td>{{ data.interval }}s</td>
                            <td id="status-{{ check_id }}">üü¢ Aktivn√≠</td>
                            <td>
                                <button class="btn btn-primary" onclick="window.location.href='{{ url_for('check_settings', check_id=check_id) }}'">‚öôÔ∏è Nastaven√≠</button>
                                <button class="btn btn-primary" onclick="pauseMonitoring('{{ check_id }}')">‚è∏Ô∏è Pozastavit</button>
                                <button class="btn btn-danger" onclick="confirmDelete('{{ check_id }}')">üóëÔ∏è Smazat</button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not active_checks %}
                        <tr id="emptyRow">
                            <td colspan="5" class="empty-state">≈Ω√°dn√© aktivn√≠ checky</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
        </div>

        <div class="history panel">
            <h2>üìú Historie ping≈Ø</h2>
            <div id="historyContainer">
                {% if history %}
                    {% for item in history %}
                    <div class="history-item">
                        <small>[{{ item.timestamp }}]</small><br>
                        <strong>{{ item.url }}</strong><br>
                        {% if item.status == 'success' %}
                            <span style="color:#28a745;">‚úÖ OK ({{ item.response_time }}ms)</span>
                        {% else %}
                            <span style="color:#dc3545;">‚ùå Chyba: {{ item.message }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">≈Ω√°dn√° historie</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="active-checks panel" style="margin-top: 20px;">
        <h2>üì° Live v√Ωsledky</h2>
        <div id="liveResults">
            <div class="empty-state">V√Ωsledky se zobraz√≠ po spu≈°tƒõn√≠ monitoringu</div>
        </div>
    </div>

    <script>
        const popupConfig = {{ popup | tojson }};
        const socket = io();
        let isMonitoring = false;

        function renderActiveChecks(checks) {
            const tbody = document.getElementById('activeChecksBody');
            tbody.innerHTML = '';
            const entries = Object.entries(checks);
            if (entries.length === 0) {
                tbody.innerHTML = '<tr id="emptyRow"><td colspan="5" class="empty-state">≈Ω√°dn√© aktivn√≠ checky</td></tr>';
                return;
            }
            for (const [cid, data] of entries) {
                const row = document.createElement('tr');
                row.id = `row-${cid}`;
                const status = data.status === 'paused' ? '‚è∏Ô∏è Pozastaveno' : 'üü¢ Aktivn√≠';
                const actionBtn = data.status === 'paused'
                    ? `<button class="btn btn-primary" onclick="resumeMonitoring('${cid}')">‚ñ∂Ô∏è Spustit</button>`
                    : `<button class="btn btn-primary" onclick="pauseMonitoring('${cid}')">‚è∏Ô∏è Pozastavit</button>`;
                row.innerHTML = `
                    <td>${data.name || ''}</td>
                    <td>${data.url}</td>
                    <td>${data.interval}s</td>
                    <td id="status-${cid}">${status}</td>
                    <td>
                        <button class="btn btn-primary" onclick="window.location.href='/check/${cid}'">‚öôÔ∏è Nastaven√≠</button>
                        ${actionBtn}
                        <button class="btn btn-danger" onclick="confirmDelete('${cid}')">üóëÔ∏è Smazat</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // P≈ôipojen√≠ k SocketIO
        socket.on('connect', function() {
            console.log('P≈ôipojeno k serveru');
            socket.emit('get_active_checks');
            socket.emit('get_history');
        });

        socket.on('active_checks_update', function(data) {
            renderActiveChecks(data);
        });

        // Nov√Ω check byl spu≈°tƒõn
        socket.on('check_started', function(data) {
            console.log('Check spu≈°tƒõn:', data);
            
            // Odstranit pr√°zdn√Ω ≈ô√°dek pokud existuje
            const emptyRow = document.getElementById('emptyRow');
            if (emptyRow) {
                emptyRow.remove();
            }
            
            // P≈ôidat nov√Ω ≈ô√°dek do tabulky
            const tbody = document.getElementById('activeChecksBody');
            const newRow = document.createElement('tr');
            newRow.id = `row-${data.check_id}`;
            newRow.innerHTML = `
                <td>${data.name || ''}</td>
                <td>${data.url}</td>
                <td>${data.interval}s</td>
                <td id="status-${data.check_id}">üü¢ Aktivn√≠</td>
                <td>
                    <button class="btn btn-primary" onclick="window.location.href='/check/${data.check_id}'">‚öôÔ∏è Nastaven√≠</button>
                    <button class="btn btn-primary" onclick="pauseMonitoring('${data.check_id}')">‚è∏Ô∏è Pozastavit</button>
                    <button class="btn btn-danger" onclick="confirmDelete('${data.check_id}')">üóëÔ∏è Smazat</button>
                </td>
            `;
            tbody.appendChild(newRow);

            // Vyƒçistit formul√°≈ô
            document.getElementById('nameInput').value = '';
            document.getElementById('urlInput').value = '';
        });

        // Check byl zastaven
        socket.on('check_stopped', function(data) {
            console.log('Check zastaven:', data);
            const row = document.getElementById(`row-${data.check_id}`);
            if (row) {
                row.remove();
            }
            
            // P≈ôidat pr√°zdn√Ω ≈ô√°dek pokud u≈æ nejsou ≈æ√°dn√© checky
            const tbody = document.getElementById('activeChecksBody');
            if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr id="emptyRow"><td colspan="5" class="empty-state">≈Ω√°dn√© aktivn√≠ checky</td></tr>';
            }
        });

        // Check byl pozastaven
        socket.on('check_paused', function(data) {
            const statusCell = document.getElementById(`status-${data.check_id}`);
            if (statusCell) {
                statusCell.innerHTML = '‚è∏Ô∏è Pozastaveno';
            }
            const row = document.getElementById(`row-${data.check_id}`);
            if (row) {
                const btn = row.querySelector('button[onclick^="pauseMonitoring"]');
                if (btn) {
                    btn.textContent = '‚ñ∂Ô∏è Spustit';
                    btn.setAttribute('onclick', `resumeMonitoring('${data.check_id}')`);
                }
            }
        });

        socket.on('check_resumed', function(data) {
            const statusCell = document.getElementById(`status-${data.check_id}`);
            if (statusCell) {
                statusCell.innerHTML = 'üü¢ Aktivn√≠';
            }
            const row = document.getElementById(`row-${data.check_id}`);
            if (row) {
                const btn = row.querySelector('button[onclick^="resumeMonitoring"]');
                if (btn) {
                    btn.textContent = '‚è∏Ô∏è Pozastavit';
                    btn.setAttribute('onclick', `pauseMonitoring('${data.check_id}')`);
                }
            }
        });

        // Aktualizace v√Ωsledku pingu
        socket.on('ping_update', function(data) {
            console.log('Ping update:', data);
            
            // Aktualizovat status v tabulce
            const statusCell = document.getElementById(`status-${data.check_id}`);
            if (statusCell) {
                if (data.status === 'success') {
                    statusCell.innerHTML = `üü¢ OK (${data.time}ms)`;
                } else {
                    statusCell.innerHTML = `üî¥ Chyba`;
                }
            }
            
            // P≈ôidat do live v√Ωsledk≈Ø
            const liveResults = document.getElementById('liveResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = data.status === 'success' ? 'ping-result ping-success' : 'ping-result ping-error';
            
            if (data.status === 'success') {
                resultDiv.innerHTML = `
                    <strong>[${data.timestamp}]</strong> ${data.url}<br>
                    ‚úÖ Status: ${data.code} | Odezva: ${data.time}ms
                `;
            } else {
                resultDiv.innerHTML = `
                    <strong>[${data.timestamp}]</strong> ${data.url}<br>
                    ‚ùå Chyba: ${data.message}
                `;
            }
            
            // Vlo≈æit na zaƒç√°tek a omezit poƒçet zobrazen√Ωch v√Ωsledk≈Ø
            if (liveResults.firstChild && liveResults.firstChild.className === 'empty-state') {
                liveResults.innerHTML = '';
            }
            liveResults.insertBefore(resultDiv, liveResults.firstChild);
            
            // Omezit na posledn√≠ch 20 v√Ωsledk≈Ø
            while (liveResults.children.length > 20) {
                liveResults.removeChild(liveResults.lastChild);
            }
        });

        // Aktualizace historie
        socket.on('history_update', function(history) {
            const container = document.getElementById('historyContainer');
            if (history.length === 0) {
                container.innerHTML = '<div class="empty-state">≈Ω√°dn√° historie</div>';
                return;
            }
            
            container.innerHTML = history.map(item => `
                <div class="history-item">
                    <small>[${item.timestamp}]</small><br>
                    <strong>${item.url}</strong><br>
                    ${item.status === 'success' 
                        ? `<span style="color:#28a745;">‚úÖ OK (${item.response_time}ms)</span>`
                        : `<span style="color:#dc3545;">‚ùå Chyba: ${item.message}</span>`}
                </div>
            `).join('');
        });

        // Funkce pro spu≈°tƒõn√≠ monitoringu
        function startMonitoring() {
            const url = document.getElementById('urlInput').value;
            const interval = document.getElementById('intervalSelect').value;
            const name = document.getElementById('nameInput').value;
            
            if (!url) {
                alert('Zadejte platnou URL adresu!');
                return;
            }
            
            socket.emit('start_monitoring', {
                url: url,
                interval: interval,
                name: name
            });
        }

        // Funkce pro pozastaven√≠ monitoringu
        function pauseMonitoring(checkId) {
            socket.emit('pause_monitoring', {
                check_id: checkId,
                minutes: 1
            });
        }

        function resumeMonitoring(checkId) {
            socket.emit('resume_monitoring', {
                check_id: checkId
            });
        }

        // Funkce pro zastaven√≠ monitoringu
        function stopMonitoring(checkId) {
            socket.emit('stop_monitoring', {
                check_id: checkId
            });
        }

        function showPopup(msg, type='info') {
            const cfg = popupConfig[type] || popupConfig.info;
            const div = document.createElement('div');
            div.className = 'popup';
            div.style.background = cfg.color;
            div.style.width = cfg.width + 'px';
            div.style.height = cfg.height + 'px';
            div.innerHTML = `<span class="close" onclick="this.parentElement.remove()">&times;</span>` + cfg.text.replace('{message}', msg);
            document.body.appendChild(div);
            setTimeout(()=>div.remove(), 3000);
        }
        function confirmDelete(checkId) {
            const cfg = popupConfig.delete;
            const div = document.createElement('div');
            div.className = 'popup';
            div.style.background = cfg.color;
            div.style.width = cfg.width + 'px';
            div.style.height = cfg.height + 'px';
            div.innerHTML = `<span class="close" onclick="this.parentElement.remove()">&times;</span>` +
                cfg.text.replace('{message}', 'Napi≈°te delete pro potvrzen√≠') +
                `<br><input type="text" id="delInput" style="width:90%;margin-top:10px;"><br>` +
                `<button class="btn" style="margin-top:5px;" onclick="if(document.getElementById('delInput').value.toLowerCase()=='delete'){ stopMonitoring('${checkId}'); this.parentElement.remove(); }">OK</button>`;
            document.body.appendChild(div);
        }

        // Automaticky naƒç√≠st historii p≈ôi naƒçten√≠ str√°nky
        window.addEventListener('load', function() {
            socket.emit('get_history');
        });
    </script>
</body>
</html>